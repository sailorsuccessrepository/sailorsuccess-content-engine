/* =========================================================
   WEB OF KNOWLEDGE (WoK) ENGINE — DATA-DRIVEN v2.0
      Auto-populated from /wok-data.json (built by wok-data.json.ts)
         Zero manual updates needed — every new article auto-appears
            ========================================================= */

            const WOK = {
              articles: [],
                glossary: [],
                  byId: {},
                    byTag: {},
                      glossaryMap: {}
                      };

                      // ─── 1. LOAD DATA FROM BUILD-TIME ENDPOINT ────────────────
                      function loadWokData(callback) {
                        fetch('/wok-data.json')
                            .then(function(r) { return r.json(); })
                                .then(function(data) {
                                      WOK.articles = data.articles || [];
                                            WOK.glossary = data.glossary || [];
                                                  buildLookups();
                                                        callback();
                                                            })
                                                                .catch(function(e) {
                                                                      console.warn('[WoK] Could not load wok-data.json, running in degraded mode:', e);
                                                                            callback();
                                                                                });
                                                                                }

                                                                                // ─── 2. BUILD LOOKUP MAPS ─────────────────────────────────
                                                                                function buildLookups() {
                                                                                  WOK.byId = {};
                                                                                    WOK.byTag = {};
                                                                                      WOK.glossaryMap = {};

                                                                                        WOK.articles.forEach(function(a) {
                                                                                            WOK.byId[a.id] = a;
                                                                                                (a.tags || []).forEach(function(t) {
                                                                                                      const key = t.toLowerCase();
                                                                                                            if (!WOK.byTag[key]) WOK.byTag[key] = [];
                                                                                                                  WOK.byTag[key].push(a);
                                                                                                                      });
                                                                                                                        });

                                                                                                                          WOK.glossary.forEach(function(g) {
                                                                                                                              const key = (g.term || '').toLowerCase();
                                                                                                                                  WOK.glossaryMap[key] = g;
                                                                                                                                      if (g.abbreviation) {
                                                                                                                                            WOK.glossaryMap[g.abbreviation.toLowerCase()] = g;
                                                                                                                                                }
                                                                                                                                                  });

                                                                                                                                                    window.WOK = WOK;
                                                                                                                                                    }

                                                                                                                                                    // ─── 3. SEARCH OVERLAY (Ctrl+K) ───────────────────────────
                                                                                                                                                    function initSearch() {
                                                                                                                                                      const overlay = document.getElementById('wok-search-overlay');
                                                                                                                                                        const input   = document.getElementById('wok-search-input');
                                                                                                                                                          const results = document.getElementById('wok-search-results');
                                                                                                                                                            if (!overlay || !input || !results) return;

                                                                                                                                                              function openSearch() { overlay.classList.add('active'); input.focus(); }
                                                                                                                                                                function closeSearch() { overlay.classList.remove('active'); input.value = ''; results.innerHTML = ''; }

                                                                                                                                                                  document.addEventListener('keydown', function(e) {
                                                                                                                                                                      if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
                                                                                                                                                                          if (e.key === 'Escape') closeSearch();
                                                                                                                                                                            });

                                                                                                                                                                              const searchTriggers = document.querySelectorAll('[data-wok-search]');
                                                                                                                                                                                searchTriggers.forEach(function(el) { el.addEventListener('click', openSearch); });

                                                                                                                                                                                  overlay.addEventListener('click', function(e) { if (e.target === overlay) closeSearch(); });

                                                                                                                                                                                    input.addEventListener('input', function() {
                                                                                                                                                                                        const q = input.value.trim().toLowerCase();
                                                                                                                                                                                            if (q.length < 2) { results.innerHTML = ''; return; }

                                                                                                                                                                                                const hits = [];
                                                                                                                                                                                                    WOK.articles.forEach(function(a) {
                                                                                                                                                                                                          const score =
                                                                                                                                                                                                                  (a.title && a.title.toLowerCase().includes(q) ? 10 : 0) +
                                                                                                                                                                                                                          (a.tags && a.tags.some(function(t) { return t.toLowerCase().includes(q); }) ? 5 : 0) +
                                                                                                                                                                                                                                  (a.excerpt && a.excerpt.toLowerCase().includes(q) ? 3 : 0) +
                                                                                                                                                                                                                                          (a.category && a.category.toLowerCase().includes(q) ? 2 : 0);
                                                                                                                                                                                                                                                if (score > 0) hits.push({ a: a, score: score });
                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                        WOK.glossary.forEach(function(g) {
                                                                                                                                                                                                                                                              if ((g.term && g.term.toLowerCase().includes(q)) ||
                                                                                                                                                                                                                                                                        (g.abbreviation && g.abbreviation.toLowerCase().includes(q)) ||
                                                                                                                                                                                                                                                                                  (g.definition && g.definition.toLowerCase().includes(q))) {
                                                                                                                                                                                                                                                                                          hits.push({ a: {
                                                                                                                                                                                                                                                                                                    title: g.term + (g.abbreviation ? ' (' + g.abbreviation + ')' : ''),
                                                                                                                                                                                                                                                                                                              excerpt: g.definition,
                                                                                                                                                                                                                                                                                                                        url: g.url || '#',
                                                                                                                                                                                                                                                                                                                                  tags: [g.tag || 'Glossary'],
                                                                                                                                                                                                                                                                                                                                            isGlossary: true
                                                                                                                                                                                                                                                                                                                                                    }, score: 4 });
                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                              });

                                                                                                                                                                                                                                                                                                                                                                  hits.sort(function(x, y) { return y.score - x.score; });
                                                                                                                                                                                                                                                                                                                                                                      const top = hits.slice(0, 8);

                                                                                                                                                                                                                                                                                                                                                                          if (top.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                results.innerHTML = '<div class="wok-no-results">No results for "' + q + '"</div>';
                                                                                                                                                                                                                                                                                                                                                                                      return;
                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                              results.innerHTML = top.map(function(h) {
                                                                                                                                                                                                                                                                                                                                                                                                    const a = h.a;
                                                                                                                                                                                                                                                                                                                                                                                                          const tag = (a.tags && a.tags[0]) ? a.tags[0] : 'Article';
                                                                                                                                                                                                                                                                                                                                                                                                                const badge = a.isGlossary ? 'Glossary' : tag;
                                                                                                                                                                                                                                                                                                                                                                                                                      return '<a href="' + a.url + '" class="wok-result-item">' +
                                                                                                                                                                                                                                                                                                                                                                                                                              '<span class="wok-result-badge">' + badge + '</span>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                      '<span class="wok-result-title">' + a.title + '</span>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                              (a.excerpt ? '<span class="wok-result-excerpt">' + a.excerpt.substring(0, 80) + '...</span>' : '') +
                                                                                                                                                                                                                                                                                                                                                                                                                                                      '</a>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                          }).join('');
                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ─── 4. KEYWORD TOOLTIPS (Investopedia-style hover) ───────
                                                                                                                                                                                                                                                                                                                                                                                                                                                            function initTooltips() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                              const content = document.querySelector('.prose, article, .article-body, main');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!content || WOK.glossary.length === 0) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const tooltip = document.createElement('div');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tooltip.className = 'wok-tooltip';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      document.body.appendChild(tooltip);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let hideTimer;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function showTooltip(el, g) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              clearTimeout(hideTimer);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const rect = el.getBoundingClientRect();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      tooltip.innerHTML =
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '<strong>' + g.term + '</strong>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (g.abbreviation ? ' <em>(' + g.abbreviation + ')</em>' : '') +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        '<p>' + (g.definition || '') + '</p>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (g.url ? '<a href="' + g.url + '">Read more →</a>' : '');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  tooltip.style.left = Math.min(rect.left + window.scrollX, window.innerWidth - 320) + 'px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      tooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          tooltip.classList.add('visible');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              function hideTooltip() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  hideTimer = setTimeout(function() { tooltip.classList.remove('visible'); }, 300);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      tooltip.addEventListener('mouseenter', function() { clearTimeout(hideTimer); });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tooltip.addEventListener('mouseleave', hideTooltip);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT, null);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const textNodes = [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              let node;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                while ((node = walker.nextNode())) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (node.parentElement && !['SCRIPT','STYLE','A','CODE','PRE'].includes(node.parentElement.tagName)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          textNodes.push(node);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const terms = Object.keys(WOK.glossaryMap).filter(function(k) { return k.length > 2; });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    textNodes.forEach(function(tn) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let html = tn.textContent || '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            let matched = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                terms.forEach(function(term) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const re = new RegExp('\\b(' + term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')\\b', 'gi');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (re.test(html)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    html = html.replace(re, '<mark class="wok-kw" data-term="$1">$1</mark>');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            matched = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (matched) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const span = document.createElement('span');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      span.innerHTML = html;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tn.parentNode.replaceChild(span, tn);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.querySelectorAll('.wok-kw').forEach(function(el) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        el.addEventListener('mouseenter', function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const key = el.getAttribute('data-term').toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const g = WOK.glossaryMap[key];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (g) showTooltip(el, g);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  el.addEventListener('mouseleave', hideTooltip);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ─── 5. TAG SLIDE-IN PANEL ────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function initTagPanels() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const panel = document.createElement('div');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        panel.id = 'wok-tag-panel';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          panel.innerHTML = '<div class="wok-tag-panel-inner"><button class="wok-tag-close">&#x2715;</button><div id="wok-tag-panel-content"></div></div>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.body.appendChild(panel);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              panel.querySelector('.wok-tag-close').addEventListener('click', function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  panel.classList.remove('open');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      document.addEventListener('click', function(e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const tagEl = e.target.closest('[data-wok-tag]');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (!tagEl) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  e.preventDefault();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const tag = tagEl.getAttribute('data-wok-tag');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const key = tag.toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const tagArticles = WOK.byTag[key] || [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const panelContent = document.getElementById('wok-tag-panel-content');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      panelContent.innerHTML = '<h3>Tag: ' + tag + '</h3>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '<p class="wok-tag-count">' + tagArticles.length + ' article' + (tagArticles.length !== 1 ? 's' : '') + '</p>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (tagArticles.length > 0 ? tagArticles.map(function(a) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return '<a href="' + a.url + '" class="wok-tag-article">' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    '<span class="wok-tag-article-title">' + a.title + '</span>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (a.excerpt ? '<span class="wok-tag-article-excerpt">' + a.excerpt.substring(0, 80) + '...</span>' : '') +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        '</a>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }).join('') : '<p class="wok-no-results">No articles found for this tag.</p>') +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    '<a href="/tags/' + encodeURIComponent(tag) + '" class="wok-tag-all-link">View all ' + tag + ' articles →</a>';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        panel.classList.add('open');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // ─── 6. RELATED ARTICLES (tag-scored) ────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function initRelated() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const container = document.getElementById('wok-related');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (!container || WOK.articles.length === 0) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const currentUrl = window.location.pathname.replace(/\/$/, '');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const current = WOK.articles.find(function(a) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return a.url.replace(/\/$/, '') === currentUrl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (!current) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const currentTags = (current.tags || []).map(function(t) { return t.toLowerCase(); });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const related = [];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                WOK.articles.forEach(function(a) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (a.id === current.id) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const sharedTags = (a.tags || []).filter(function(t) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return currentTags.includes(t.toLowerCase());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }).length;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const sameCategory = a.category === current.category ? 2 : 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const score = sharedTags * 3 + sameCategory;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (score > 0) related.push({ a: a, score: score });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  related.sort(function(x, y) { return y.score - x.score; });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const top = related.slice(0, 4);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (top.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          container.style.display = 'none';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  container.innerHTML = '<h3 class="wok-related-heading">Related Articles</h3>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      '<div class="wok-related-grid">' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          top.map(function(r) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return '<a href="' + r.a.url + '" class="wok-related-card">' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        '<span class="wok-related-card-title">' + r.a.title + '</span>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (r.a.excerpt ? '<span class="wok-related-card-excerpt">' + r.a.excerpt.substring(0, 70) + '...</span>' : '') +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        '<span class="wok-related-card-tags">' + (r.a.tags || []).slice(0, 3).map(function(t) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return '<span class="wok-tag-chip" data-wok-tag="' + t + '">' + t + '</span>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }).join('') + '</span>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  '</a>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }).join('') +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          '</div>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // ─── 7. NEXT READ CARD ───────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function initNextRead() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const container = document.getElementById('wok-next-read');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (!container || WOK.articles.length === 0) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const currentUrl = window.location.pathname.replace(/\/$/, '');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const idx = WOK.articles.findIndex(function(a) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return a.url.replace(/\/$/, '') === currentUrl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          let next = null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (idx !== -1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const current = WOK.articles[idx];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const currentTags = (current.tags || []).map(function(t) { return t.toLowerCase(); });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const candidates = WOK.articles.filter(function(a, i) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (i === idx) return false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return (a.tags || []).some(function(t) { return currentTags.includes(t.toLowerCase()); });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            next = candidates[Math.floor(Math.random() * candidates.length)] || WOK.articles[(idx + 1) % WOK.articles.length];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  next = WOK.articles[0];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!next) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        container.innerHTML =
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '<div class="wok-next-inner">' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                '<span class="wok-next-label">Next Read</span>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    '<a href="' + next.url + '" class="wok-next-title">' + next.title + '</a>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (next.excerpt ? '<p class="wok-next-excerpt">' + next.excerpt.substring(0, 100) + '...</p>' : '') +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '<a href="' + next.url + '" class="wok-next-btn">Continue Reading →</a>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                '</div>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // ─── 8. SIDEBAR WIDGETS ──────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function initSidebar() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const tagCloud = document.getElementById('wok-tag-cloud');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const popularList = document.getElementById('wok-popular');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (tagCloud && Object.keys(WOK.byTag).length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const sortedTags = Object.keys(WOK.byTag)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .sort(function(a, b) { return WOK.byTag[b].length - WOK.byTag[a].length; })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .slice(0, 30);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          tagCloud.innerHTML = sortedTags.map(function(t) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const count = WOK.byTag[t].length;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const displayTag = WOK.byTag[t][0].tags.find(function(orig) { return orig.toLowerCase() === t; }) || t;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return '<a class="wok-cloud-tag" data-wok-tag="' + displayTag + '" href="/tags/' + encodeURIComponent(displayTag) + '" style="font-size:' + Math.min(0.75 + count * 0.08, 1.15) + 'rem">' + displayTag + ' <sup>' + count + '</sup></a>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }).join(' ');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (popularList && WOK.articles.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const featured = WOK.articles.filter(function(a) { return a.featured; }).slice(0, 5);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const list = featured.length >= 3 ? featured : WOK.articles.slice(0, 5);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                popularList.innerHTML = list.map(function(a, i) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return '<a href="' + a.url + '" class="wok-popular-item">' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              '<span class="wok-popular-num">0' + (i + 1) + '</span>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      '<span class="wok-popular-title">' + a.title + '</span>' +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              '</a>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }).join('');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ─── 9. INLINE TAG CHIPS ────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function initInlineTags() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      document.querySelectorAll('.wok-tag-chip:not([data-wok-tag])').forEach(function(el) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const tag = el.textContent.trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (tag) el.setAttribute('data-wok-tag', tag);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // ─── 10. MAIN INIT ───────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function initUI() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  initSearch();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    initTooltips();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      initTagPanels();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        initRelated();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          initNextRead();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            initSidebar();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              initInlineTags();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (document.readyState === 'loading') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.addEventListener('DOMContentLoaded', function() { loadWokData(initUI); });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  loadWokData(initUI);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }